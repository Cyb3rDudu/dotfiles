# macOS-specific Makefile
# Handles Homebrew package installation and dotfile symlinking

.PHONY: install link check-stow setup-secrets

install: check-stow link setup-secrets
	@echo "✓ macOS dotfiles installed successfully"
	@echo ""
	@echo "Next steps:"
	@echo "  1. Copy secrets templates: cp fish/dot-config/fish/conf.d/99-secrets.fish.template ~/.config/fish/conf.d/99-secrets.fish"
	@echo "  2. Edit ~/.config/fish/conf.d/99-secrets.fish with your actual credentials"
	@echo "  3. Restart your terminal completely (not just the shell)"
	@echo ""
	@echo "Optional - For Nushell as login shell:"
	@echo "  4. Load LaunchAgent: launchctl load ~/Library/LaunchAgents/environment.plist"
	@echo "  5. Log out and log back in for XDG variables to take effect"
	@echo "  6. See launchagents/README.md for details"

check-stow:
	@command -v stow >/dev/null 2>&1 || { \
		echo "GNU Stow not found. Installing via Homebrew..."; \
		brew install stow; \
	}

link:
	@echo "Symlinking dotfiles..."
	@stow --dotfiles -t $(HOME) bash
	@stow --dotfiles -t $(HOME) fish
	@stow --dotfiles -t $(HOME) zsh
	@stow --dotfiles -t $(HOME) nushell
	@stow --dotfiles -t $(HOME) tmux
	@stow --dotfiles -t $(HOME) starship
	@stow --dotfiles -t $(HOME) atuin
	@stow --dotfiles -t $(HOME) git
	@stow --dotfiles -t $(HOME) launchagents
	@stow --dotfiles -t $(HOME) claude
	@stow --dotfiles -t $(HOME) opencode
	@stow --dotfiles -t $(HOME) codex
	@stow --dotfiles -t $(HOME) claude-code-router
	@echo "✓ Symlinks created"

setup-secrets:
	@echo ""
	@echo "Setting up secrets templates..."
	@mkdir -p $(HOME)/.config/fish/conf.d
	@mkdir -p $(HOME)/.bashrc.d
	@mkdir -p $(HOME)/.zshrc.d
	@mkdir -p $(HOME)/.config/nushell/env.d
	@if [ ! -f $(HOME)/.config/fish/conf.d/99-secrets.fish ]; then \
		echo "  Creating Fish secrets template..."; \
		cp fish/dot-config/fish/conf.d/99-secrets.fish.template $(HOME)/.config/fish/conf.d/99-secrets.fish; \
	fi
	@if [ ! -f $(HOME)/.bashrc.d/99-secrets.bash ]; then \
		echo "  Creating Bash secrets template..."; \
		cp bash/dot-bashrc.d/99-secrets.bash.template $(HOME)/.bashrc.d/99-secrets.bash; \
	fi
	@if [ ! -f $(HOME)/.zshrc.d/99-secrets.zsh ]; then \
		echo "  Creating Zsh secrets template..."; \
		cp zsh/dot-zshrc.d/99-secrets.zsh.template $(HOME)/.zshrc.d/99-secrets.zsh; \
	fi
	@if [ ! -f $(HOME)/.config/nushell/env.d/99-secrets.nu ]; then \
		echo "  Creating Nushell secrets template..."; \
		cp nushell/dot-config/nushell/env.d/99-secrets.nu.template $(HOME)/.config/nushell/env.d/99-secrets.nu; \
	fi
	@if [ ! -f $(HOME)/.codex/config.toml ]; then \
		echo "  Creating Codex config template..."; \
		cp codex/dot-codex/config.toml.template $(HOME)/.codex/config.toml; \
	fi
	@if [ ! -f $(HOME)/.claude-code-router/config.json ]; then \
		echo "  Creating Claude Code Router config template..."; \
		cp claude-code-router/dot-claude-code-router/config.json.template $(HOME)/.claude-code-router/config.json; \
	fi
	@echo "✓ Secrets templates created"
	@echo ""
	@echo "AI Tool Configs:"
	@echo "  - OpenCode & Claude use environment variable substitution (\$${VAR})"
	@echo "  - Codex & Claude Code Router configs created from templates"
	@echo "  - Edit ~/.codex/config.toml and ~/.claude-code-router/config.json"
	@echo "  - Replace REPLACE_WITH_YOUR_* placeholders with actual credentials"
