#!/usr/bin/env sh

set -eu

COMMIT_MSG_FILE=${1:-}
if [ -z "$COMMIT_MSG_FILE" ]; then
  echo "commit msg file is required" >&2
  exit 1
fi

# Ignore automatic merge commits or branch merges like "A into B"
if grep -Eq " into |^Merge " "$COMMIT_MSG_FILE"; then
  exit 0
fi

# Conventional Commit format with flat scope (no slashes)
# - allowed types
# - optional single, flat scope using only [a-zA-Z0-9_.-]
# - optional breaking change marker '!'
# - colon + space + description
CONVENTIONAL_COMMIT_REGEX='^(feat|fix|docs|style|refactor|test|chore|build|ci|perf|revert)(\([a-zA-Z0-9_.-]+\))?(!)?: .+$'

# Extract the first non-comment, non-empty line as the subject
subject=$(grep -vE '^[[:space:]]*#|^[[:space:]]*$' "$COMMIT_MSG_FILE" | head -n 1 || true)

if [ -z "${subject}" ]; then
  # Empty message (e.g., WIP commit with comments only) â€” allow
  exit 0
fi

# Enforce format
if ! printf "%s" "$subject" | grep -Eq "$CONVENTIONAL_COMMIT_REGEX"; then
  echo "ERROR: Commit message does not follow Conventional Commits format." >&2
  echo >&2
  echo "Subject must be: <type>(<flat-scope>): <description>" >&2
  echo "Valid types: feat, fix, docs, style, refactor, test, chore, build, ci, perf, revert" >&2
  echo >&2
  echo "Examples:" >&2
  echo "  feat(auth): add login functionality" >&2
  echo "  fix(api)!: resolve timeout issue" >&2
  echo "  docs(readme): update installation instructions" >&2
  exit 1
fi

# Additional guard: reject nested scopes like backend/api
scope=$(printf "%s" "$subject" | sed -nE 's/^[a-z]+\(([a-zA-Z0-9_.\/-]+)\):.*/\1/p') || true
if [ -n "${scope}" ] && printf "%s" "$scope" | grep -q "/"; then
  echo "ERROR: Scope must be flat (no '/'). Use 'api' instead of 'backend/api'." >&2
  exit 1
fi

exit 0
