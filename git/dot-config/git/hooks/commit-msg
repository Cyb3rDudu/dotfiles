#!/usr/bin/env sh

set -eu

COMMIT_MSG_FILE=${1:-}
if [ -z "$COMMIT_MSG_FILE" ]; then
  echo "commit msg file is required" >&2
  exit 1
fi

# Conventional Commit format
# - allowed types
# - optional breaking change marker '!'
# - colon + space + description
# Scope policy: require flat scope unless overridden
REQUIRE_SCOPE=${REQUIRE_SCOPE:-1}
CONVENTIONAL_COMMIT_REGEX='^(feat|fix|docs|style|refactor|test|chore|build|ci|perf|revert|debug)(\([A-Za-z0-9_.-]+\))?(!)?: .+$'
REQUIRED_SCOPE_REGEX='^(feat|fix|docs|style|refactor|test|chore|build|ci|perf|revert|debug)\([A-Za-z0-9_.-]+\)(!)?: .+$'

add_error() {
  if [ -z "${errors:-}" ]; then
    errors="$1"
  else
    errors="${errors}

$1"
  fi
}

errors=""

# Extract the first non-comment, non-empty line as the subject
subject=$(grep -vE '^[[:space:]]*#|^[[:space:]]*$' "$COMMIT_MSG_FILE" | head -n 1 || true)

# Ignore automatic merge commits; only check the subject line
if printf "%s" "$subject" | grep -Eq '^Merge( branch)? ' ; then
  exit 0
fi

if [ -z "${subject}" ]; then
  # Empty message (e.g., WIP commit with comments only) — allow
  exit 0
fi

# Reject AI assistant signature lines (Claude), even if altered
# Matches e.g.:
#   Generated with [Claude ...]
#   generated with: Claude
#   Co-authored-by: Claude <...>
#   Co Authored By: Claude
if grep -viE '^[[:space:]]*#' "$COMMIT_MSG_FILE" | \
   grep -qiE '^[[:space:]]*co[- ]?authored[- ]?by:[[:space:]]*.*claude|generated[[:space:]]+with.*claude'; then
  add_error "$(cat <<'EOF'
ERROR: AI assistant signature detected (Claude).
Please recommit without signature lines such as 'Generated with Claude …' or 'Co-Authored-By: Claude <…>'.
EOF
)"
fi

# Enforce format
if ! printf "%s" "$subject" | grep -Eq "$CONVENTIONAL_COMMIT_REGEX"; then
  add_error "$(cat <<'EOF'
ERROR: Commit message does not follow Conventional Commits format.

Subject must be: <type>(<flat-scope>): <description>
Valid types: feat, fix, docs, style, refactor, test, chore, build, ci, perf, revert, debug

Examples:
  feat(auth): add login functionality
  fix(api)!: resolve timeout issue
  docs(readme): update installation instructions
EOF
)"
fi

# Require scope if enabled
if [ "$REQUIRE_SCOPE" = "1" ]; then
  if ! printf "%s" "$subject" | grep -Eq "$REQUIRED_SCOPE_REGEX"; then
    add_error "$(cat <<'EOF'
ERROR: Scope is required and must be flat (no '/').
Example: feat(api): add request caching
EOF
)"
  fi
fi

# Additional guard: reject nested scopes like backend/api
scope=$(printf "%s" "$subject" | sed -nE 's/^[a-z]+\(([a-zA-Z0-9_.\/-]+)\):.*/\1/p') || true
if [ -n "${scope}" ] && printf "%s" "$scope" | grep -q "/"; then
  add_error "ERROR: Scope must be flat (no '/'). Use 'api' instead of 'backend/api'."
fi

if [ -n "$errors" ]; then
  printf '%s\n' "$errors" >&2
  exit 1
fi

exit 0
